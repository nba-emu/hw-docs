<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>NBA hardware documentation</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="foreword.html"><strong aria-hidden="true">1.</strong> Foreword</a></li><li class="chapter-item expanded "><a href="timers.html"><strong aria-hidden="true">2.</strong> Timers</a></li><li class="chapter-item expanded "><a href="ppu/ppu.html"><strong aria-hidden="true">3.</strong> PPU</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ppu/background.html"><strong aria-hidden="true">3.1.</strong> Background</a></li><li class="chapter-item expanded "><a href="ppu/sprite.html"><strong aria-hidden="true">3.2.</strong> Sprite</a></li><li class="chapter-item expanded "><a href="ppu/composite.html"><strong aria-hidden="true">3.3.</strong> Composite</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">NBA hardware documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="foreword"><a class="header" href="#foreword">Foreword</a></h1>
<p>This documentation was created out of the need to document new Game Boy Advance hardware research findings.</p>
<p>It does not currently aim to replace existing documentation, as that would be a massive undertaking.
Instead it aims to complement existing documentation and to correct it where it is inaccurate.</p>
<p>The target audience for this documentation should mostly be emulator developers and individuals who
are curious to learn how the Game Boy Advance really operates.
Homebrew programmers might be inclined towards a more comprehensive documentation in most cases for now.</p>
<h2 id="other-resources"><a class="header" href="#other-resources">Other resources</a></h2>
<ul>
<li><a href="https://problemkaputt.de/gbatek.htm">GBATEK</a> — the most comprehensive GBA documentation, by Martin Korth (NO$GBA developer)</li>
<li><a href="https://www.coranac.com/tonc/text/">Tonc</a> — GBA programming tutorial, by cearn</li>
<li><a href="http://gbadev.net/gbadoc/">gbadoc</a> — new community-driven GBA documentation, by the GBADev community (WIP)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="timers"><a class="header" href="#timers">Timers</a></h1>
<p>The Game Boy Advance has four 16-bit hardware timers (<strong>TM</strong>0 - <strong>TM</strong>3 or generally <strong>TM</strong>[x]).</p>
<p>Each timer is made up of a 16-bit counter, a 16-bit reload value and a control register.</p>
<h2 id="io-registers"><a class="header" href="#io-registers">IO registers</a></h2>
<h3 id="overview"><a class="header" href="#overview">Overview</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Address</th><th>Name</th><th>Description</th></tr></thead><tbody>
<tr><td>0x04000100</td><td>TM0D</td><td>Timer #0 counter (on read) and reload (on write) value</td></tr>
<tr><td>0x04000102</td><td>TM0CNT</td><td>Timer #0 control register</td></tr>
<tr><td>0x04000104</td><td>TM1D</td><td>Timer #1 counter (on read) and reload (on write) value</td></tr>
<tr><td>0x04000106</td><td>TM1CNT</td><td>Timer #1 control register</td></tr>
<tr><td>0x04000108</td><td>TM2D</td><td>Timer #2 counter (on read) and reload (on write) value</td></tr>
<tr><td>0x0400010A</td><td>TM2CNT</td><td>Timer #2 control register</td></tr>
<tr><td>0x0400010C</td><td>TM3D</td><td>Timer #3 counter (on read) and reload (on write) value</td></tr>
<tr><td>0x0400010E</td><td>TM3CNT</td><td>Timer #3 control register</td></tr>
</tbody></table>
</div>
<h3 id="tmxd"><a class="header" href="#tmxd">TM[x]D</a></h3>
<p>Reads return the current 16-bit counter value. Writes set the 16-bit reload value.</p>
<h3 id="tmxcnt"><a class="header" href="#tmxcnt">TM[x]CNT</a></h3>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Bit(s)</th><th style="text-align: center">R/W</th><th>Name</th><th>Description</th></tr></thead><tbody>
<tr><td style="text-align: center">0 - 1</td><td style="text-align: center">RW</td><td>Clock Divider</td><td>Select a clock divider frequency (see <a href="timers.html#clock-divider">Clock Divider</a>)</td></tr>
<tr><td style="text-align: center">2</td><td style="text-align: center">RW</td><td>Clock Select <sup class="footnote-reference"><a href="#1">1</a></sup></td><td>0 = clock divider output, 1 = on <strong>TM</strong>[x-1] overflow</td></tr>
<tr><td style="text-align: center">3 - 5</td><td style="text-align: center">0</td><td>Unused</td><td></td></tr>
<tr><td style="text-align: center">6</td><td style="text-align: center">RW</td><td>IRQ enable</td><td>0 = IRQ disabled, 1 = IRQ enabled</td></tr>
<tr><td style="text-align: center">7</td><td style="text-align: center">RW</td><td>Enable</td><td>0 = disable, 1 = enabled</td></tr>
<tr><td style="text-align: center">8 - 15</td><td style="text-align: center">0</td><td>Unused</td><td></td></tr>
</tbody></table>
</div>
<h4 id="clock-divider"><a class="header" href="#clock-divider">Clock Divider</a></h4>
<p>The 16 MiHz (16.777.216 Hz) system clock is divided into four frequencies using a single clock divider.</p>
<p>When a timer uses the system clock (meaning <code>Clock Select</code> is zero), it runs at one of those frequencies:</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">Value</th><th>Frequency</th><th style="text-align: center">Divisor</th></tr></thead><tbody>
<tr><td style="text-align: center">0</td><td>16 MiHz</td><td style="text-align: center">1</td></tr>
<tr><td style="text-align: center">1</td><td>256 KiHz</td><td style="text-align: center">64</td></tr>
<tr><td style="text-align: center">2</td><td>64 KiHz</td><td style="text-align: center">256</td></tr>
<tr><td style="text-align: center">3</td><td>16 KiHz</td><td style="text-align: center">1024</td></tr>
</tbody></table>
</div>
<p>The relation between frequency and divisor is: <code>Frequency = 16 MiHz / Divisor</code></p>
<h2 id="functionality"><a class="header" href="#functionality">Functionality</a></h2>
<p>When the enable bit (<strong>TM</strong>[x]<strong>CNT</strong>.bit7) changes from <code>0</code> to <code>1</code> the reload value is loaded into the counter.</p>
<p>While the enable bit is set, the counter is incremented every time its input clock pulses:</p>
<ul>
<li>when <code>Clock Select = 0</code>: at the frequency selected via <code>Clock Divider</code>.</li>
<li>when <code>Clock Select = 1</code>: when <strong>TM</strong>[x-1] ticks and overflows (the overflow flag of <strong>TM</strong>[x-1] is connected as input clock).</li>
</ul>
<p>When the 16-bit counter overflows:</p>
<ol>
<li>the reload value is loaded into the counter</li>
<li>if IRQ enable (<strong>TM</strong>[x]<strong>CNT</strong>.bit6) is set: an IRQ is requested in <strong>IE</strong> bit <code>3 + x</code></li>
</ol>
<h2 id="timing-notes"><a class="header" href="#timing-notes">Timing notes</a></h2>
<ol>
<li>Changes to <strong>TM</strong>[x]<strong>D</strong> and <strong>TM</strong>[x]<strong>CNT</strong> take one cycle to apply<sup class="footnote-reference"><a href="#2">2</a></sup>.</li>
<li>The clock divider appears to generate pulses every <code>n</code> cycles (where <code>n</code> is the divisor) relative to system startup (meaning a timer can tick in less than <code>n</code> cycles after it was enabled). This however hasn't been thoroughly researched yet.</li>
</ol>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>for <strong>TM</strong>0 this bit always reads zero (the clock divider output is forcibly used)</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>See <a href="https://github.com/nba-emu/hw-test/tree/master/timer/reload">timer/reload</a> and <a href="https://github.com/nba-emu/hw-test/tree/master/timer/start-stop">timer/start-stop</a> </p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ppu"><a class="header" href="#ppu">PPU</a></h1>
<p>The following sections describe the RAM access patterns that the PPU employs to render backgrounds,
sprites and to composite the final output image.</p>
<ul>
<li><a href="ppu/./background.html">Background rendering</a> — BG VRAM accesses in BG modes #0 to #5</li>
<li><a href="ppu/./sprite.html">Sprite rendering</a> —  OAM and OBJ VRAM accesses</li>
<li><a href="ppu/./composite.html">Layer compositing</a> — PRAM accesses</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="background-rendering"><a class="header" href="#background-rendering">Background rendering</a></h1>
<p>The PPU renders background pixels during all visible scanlines (0 to 159). In each scanline it renders all pixels for the current scanline, meaning that unlike sprite rendering all background rendering happens in the same scanline.</p>
<p>For every background (BG0 - BG3) there is a wait/idle period for a number of clock cycles before the PPU begins rendering that background according to the VRAM access patterns laid out below. Usually the length of the wait period is 31 clock cycles, however it may be shorter for text-mode backgrounds which use horizontal scrolling, as described in more detail in the <a href="ppu/background.html#mode-0-bg0-3-text-mode">Mode 0</a> section.</p>
<p>Once the wait period for a given background has passed, the PPU renders pixels until it enters the horizontal blanking period (h-blank) (cycle #1005 appears to be the last cycle that may fetch data).
If all visible 240 pixels have been rendered, before the PPU reaches the h-blank period, it does not stop rendering pixels early. It renders more pixels (which are discarded) until the h-blank  period.</p>
<p>The hardware fetches <strong>on average</strong> one background pixel (for every enabled background) every four cycles. For affine tilemap and bitmap modes this is the true rate at which pixels are fetched, however for text-mode backgrounds the access pattern is slightly more complicated.</p>
<h2 id="legend"><a class="header" href="#legend">Legend</a></h2>
<pre><code>- = no fetch
M = fetch map entry (8-bit for affine maps or 16-bit for text-mode maps)
T = fetch tile data
B = fetch bitmap (8-bit palette index or 16-bit color)
</code></pre>
<h2 id="mode-0-bg0---bg3-text-mode"><a class="header" href="#mode-0-bg0---bg3-text-mode">Mode 0 (BG0 - BG3 text mode)</a></h2>
<p>Text-mode backgrounds are rendered tile-by-tile. Within 32 cycles a single tilemap-entry is rendered for each enabled background, starting with the left-most visible tilemap-entry. Normally 30<sup class="footnote-reference"><a href="#1">1</a></sup> tilemap-entries are rendered per scanline. However when sub-tile<sup class="footnote-reference"><a href="#2">2</a></sup> horizontal scrolling is used then an additional tilemap-entry needs to be rendered. Notice that while in this case the first and last tile are partially off-screen, hardware still fetches the full data for all eight pixels. The off-screen pixels simply are discarded.</p>
<p>Normally rendering for text-mode backgrounds starts at 31 cycles into the scanline. When a background has sub-tile scrolling<sup class="footnote-reference"><a href="#2">2</a></sup>, then its start time is shifted closer to the start of the scanline by four cycles per sub-tile scrolled pixel. That is to say, the start time can be calculated from the <strong>BG</strong>[x]<strong>HOFS</strong> register: <code>31 - 4 * (BG[x]HOFS mod 8)</code>. This is presumably done to ensure that the <em>actually</em> visible pixels are always available in time to be consumed by the composite step.</p>
<p>To render a tilemap-entry the relevant 16-bit descriptor is first fetched from the tilemap. The hardware then performs another two (4BPP) or four (8BPP) 16-bit VRAM fetches to read a full eight pixel line from the tile data.</p>
<h3 id="4bpp-access-patterns"><a class="header" href="#4bpp-access-patterns">4BPP access patterns</a></h3>
<pre><code>BG0: M--- T--- ---- ---- ---- T--- ---- ----
BG1: -M-- -T-- ---- ---- ---- -T-- ---- ----
BG2: --M- --T- ---- ---- ---- --T- ---- ----
BG3: ---M ---T ---- ---- ---- ---T ---- ----
</code></pre>
<h3 id="8bpp-access-patterns"><a class="header" href="#8bpp-access-patterns">8BPP access patterns</a></h3>
<pre><code>BG0: M--- T--- ---- T--- ---- T--- ---- T---
BG1: -M-- -T-- ---- -T-- ---- -T-- ---- -T--
BG2: --M- --T- ---- --T- ---- --T- ---- --T-
BG3: ---M ---T ---- ---T ---- ---T ---- ---T
</code></pre>
<h2 id="mode-1-bg0---bg1-text-mode-bg2-affine-tilemap"><a class="header" href="#mode-1-bg0---bg1-text-mode-bg2-affine-tilemap">Mode 1 (BG0 - BG1 text mode; BG2 affine tilemap)</a></h2>
<p>Presumably just works like Mode 0 for BG0 and BG1 and like Mode 2 for BG2.</p>
<h2 id="mode-2-bg2---bg3-affine-tilemap"><a class="header" href="#mode-2-bg2---bg3-affine-tilemap">Mode 2 (BG2 - BG3 affine tilemap)</a></h2>
<p>Affine tilemap backgrounds are rendered pixel-by-pixel, starting with the left-most screen pixel.</p>
<p>Every four cycles one BG2 and one BG3 pixel is fetched. In the first cycle the respective BG3 tilemap-entry is fetched. In the second cycle the corresponding tile data is fetched.
The third and fourth cycles repeat the same process for BG2.</p>
<p>Even if the current tilemap pixel coordinate is out-of-bounds and wraparound is disabled in <strong>BG</strong>[x]<strong>CNT</strong>, the pixel will still be fetched (the fetched data will be discarded).</p>
<pre><code>BG2: --MT --MT --MT --MT --MT --MT --MT --MT
BG3: MT-- MT-- MT-- MT-- MT-- MT-- MT-- MT--
</code></pre>
<h2 id="mode-3---5-bg2-affine-bitmap-modes"><a class="header" href="#mode-3---5-bg2-affine-bitmap-modes">Mode 3 - 5 (BG2 affine bitmap modes)</a></h2>
<p>The bitmap background (BG2) is rendered pixel-by-pixel, starting with the left-most screen pixel.</p>
<p>Every four cycles a single pixel is fetched from the BG2 bitmap.
This is the case even if the current bitmap pixel coordinate is out-of-bounds of the bitmap (the fetched data will be discarded).</p>
<pre><code>BG2: ---B ---B ---B ---B ---B ---B ---B ---B
</code></pre>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>240 pixels / 8 pixels per tile</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>this means that <strong>BG</strong>[x]<strong>HOFS</strong> is not divisible by eight.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sprite-rendering"><a class="header" href="#sprite-rendering">Sprite rendering</a></h1>
<p>The PPU renders sprites during all visible scanlines (0 to 159) and also during the last scanline (227) of the vertical blanking period.
Sprites are rendered one scanline ahead.
This means sprite rendering for line 0 starts during line 227 and rendering for line 1 in line 0 and so on.</p>
<p>Sprite rendering for the current scanline starts at cycle #40 of the previous scanline and continues either until the horizontal blanking period of that previous scanline (if <strong>DISPCNT</strong>.bit5 = 1)
or until cycle #40 of the current scanline (if <strong>DISPCNT</strong>.bit5 = 0).</p>
<p>The sprites are rendered in order from the lowest OAM entry (OAM #0) to the highest entry (OAM #127).
The rendering is done with two pipeline stages: an OAM attribute/matrix fetch stage and a VRAM pixel fetch stage.
Both stages only access OAM/VRAM every two cycles, every odd cycle does not access any memory.</p>
<h2 id="oam-fetch-stage"><a class="header" href="#oam-fetch-stage">OAM fetch stage</a></h2>
<p>For every OAM entry the OAM fetch stage first fetches sprite attributes #0 and #1 (single 32-bit read) in cycle #0.
It then decides based on the attributes if the sprite is enabled and vertically intersects the scanline that is rendered.
If this is the case then it fetches attribute #2 in cycle #2 and, if the sprite is affine, the four 2x2 matrix components in cycles #4, #6, #8 and #10 <sup class="footnote-reference"><a href="#1">1</a></sup>.</p>
<p>Once this pipeline stage has identified an OAM entry that should be rendered, it activates the VRAM fetch stage.
The OAM fetch stage is stalled for all active VRAM fetch stage cycles except for the first and the next-to-last cycles.
That is enough to prefetch OAM attributes #0 and #1 for the next OAM entry and either attribute #2 for the next OAM entry or attributes #0 and #1 for the OAM entry after.</p>
<h2 id="vram-fetch-stage"><a class="header" href="#vram-fetch-stage">VRAM fetch stage</a></h2>
<p>The VRAM fetch stage fetches tile data for every sprite pixel in the rendered scanline.</p>
<p>For regular sprites <code>width / 2</code> 16-bit VRAM accesses are performed (one access every two cycles).
With each access two pixels are rendered (even for 4BPP tile data).</p>
<p>For affine sprites this stage does not perform a VRAM access during the first two render cycles.
It then performs <code>width</code> VRAM accesses (one access every two cycles).
With each access a single pixel is rendered.
Notice that using the 'double area' feature doubles the number of VRAM accesses.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<h3 id="legend-1"><a class="header" href="#legend-1">Legend</a></h3>
<pre><code>- = no fetch
A01 = fetch OBJ Attribute 0 and Attribute 1 (single 32-bit OAM read)
A2 = fetch OBJ Attribute 2
PA = fetch matrix entry #0
PB = fetch matrix entry #1
PC = fetch matrix entry #2
PD = fetch matrix entry #3
V = fetch VRAM tile data
</code></pre>
<h3 id="oam-0---oam-3-rendered-non-affine-and-8-pixels-wide-oam-4---oam-127-disabledculled"><a class="header" href="#oam-0---oam-3-rendered-non-affine-and-8-pixels-wide-oam-4---oam-127-disabledculled">OAM #0 - OAM #3 rendered, non-affine and 8 pixels wide, OAM #4 - OAM #127 disabled/culled</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Cycle</th><th style="text-align: center">OAM #0</th><th style="text-align: center">OAM #1</th><th style="text-align: center">OAM #2</th><th style="text-align: center">OAM #3</th><th style="text-align: center">OAM #4</th><th style="text-align: center">OAM #5</th></tr></thead><tbody>
<tr><td>0</td><td style="text-align: center">A01</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>2</td><td style="text-align: center">A2</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>4</td><td style="text-align: center">V</td><td style="text-align: center">A01</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>6</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>8</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>10</td><td style="text-align: center">V</td><td style="text-align: center">A2</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>12</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">A01</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>14</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>16</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>18</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">A2</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>20</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">A01</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>22</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>24</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>26</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">A2</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>28</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">A01</td><td style="text-align: center">-</td></tr>
<tr><td>30</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>32</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>34</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">A01</td></tr>
</tbody></table>
</div>
<h3 id="oam-0---oam-3-enabled-affine-and-8-pixels-wide-oam-4---oam-128-disabledculled"><a class="header" href="#oam-0---oam-3-enabled-affine-and-8-pixels-wide-oam-4---oam-128-disabledculled">OAM #0 - OAM #3 enabled, affine and 8 pixels wide, OAM #4 - OAM #128 disabled/culled</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Cycle</th><th style="text-align: center">OAM #0</th><th style="text-align: center">OAM #1</th><th style="text-align: center">OAM #2</th><th style="text-align: center">OAM #3</th><th style="text-align: center">OAM #4</th><th style="text-align: center">OAM #5</th></tr></thead><tbody>
<tr><td>0</td><td style="text-align: center">A01</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>2</td><td style="text-align: center">A2</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>4</td><td style="text-align: center">PA</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>8</td><td style="text-align: center">PB</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>10</td><td style="text-align: center">PC</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>12</td><td style="text-align: center">PD</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>14</td><td style="text-align: center">-</td><td style="text-align: center">A01</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>16</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>18</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>20</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>22</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>24</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>26</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>28</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>30</td><td style="text-align: center">V</td><td style="text-align: center">A2</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>32</td><td style="text-align: center">-</td><td style="text-align: center">PA</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>34</td><td style="text-align: center">-</td><td style="text-align: center">PB</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>36</td><td style="text-align: center">-</td><td style="text-align: center">PC</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>38</td><td style="text-align: center">-</td><td style="text-align: center">PD</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>40</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">A01</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>42</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>44</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>46</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>48</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>50</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>52</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>54</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>56</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">A2</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>58</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">PA</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>60</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">PB</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>62</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">PC</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>64</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">PD</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>66</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">A01</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>68</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>70</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>72</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>74</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>76</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>78</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>80</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>82</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">A2</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>84</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">PA</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>86</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">PB</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>88</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">PC</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>90</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">PD</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>92</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">A01</td><td style="text-align: center">-</td></tr>
<tr><td>94</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>96</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>98</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>100</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>102</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>104</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>106</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">-</td></tr>
<tr><td>108</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">-</td><td style="text-align: center">V</td><td style="text-align: center">-</td><td style="text-align: center">A01</td></tr>
</tbody></table>
</div>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>the order in which the matrix components are fetched is not known yet.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="layer-compositing"><a class="header" href="#layer-compositing">Layer compositing</a></h1>
<p>Compositing of the background, sprite and backdrop layers begins after a wait period of 46 cycles.
The PPU then composites an output pixel every four cycles. The last pixel will be completed on cycle #1006 (<code>46 + 4 * 240 = 1008</code>).
It does this during all visible scanlines (0 to 159) and always composites pixels for the current scanline.</p>
<p>For each output pixel the top two opaque layers for that pixel are extracted. Then up to two Palette RAM (PRAM) accesses are performed, to resolve palette indices from the background or sprite layers to 16-bit colors or to get the backdrop colour. The first PRAM access  resolves the colour for the top-most layer and the second PRAM access the colour for the second top-most layer.</p>
<p>For both layers, there are distinctive conditions that decide whether the respective PRAM access will be performed or not.</p>
<h2 id="top-most-layer-condition"><a class="header" href="#top-most-layer-condition">Top-most layer condition</a></h2>
<ul>
<li>not (PPU is in Mode 3 and the layer is BG2)</li>
</ul>
<h2 id="second-top-most-layer-condition"><a class="header" href="#second-top-most-layer-condition">Second top-most layer condition</a></h2>
<ul>
<li>not (PPU is in Mode 3 and the layer is BG2)</li>
<li>Alpha-blending is enabled</li>
<li>The top-most layer is selected as the first blend target</li>
<li>The second top-most layer selected as the second blend target</li>
</ul>
<p>Notice that for both layers the access is not performed when the PPU is in Mode 3 and the layer is BG2. This simply is because the BG2 bitmap in Mode 3 does not use palettes and fetches 16-bit colors directly from VRAM.</p>
<h2 id="pram-access-pattern"><a class="header" href="#pram-access-pattern">PRAM access pattern</a></h2>
<pre><code>A-B- A-B- A-B- A-B- ...

- = no fetch
A = top-most layer PRAM fetch
B = second top-most layer PRAM fetch
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
